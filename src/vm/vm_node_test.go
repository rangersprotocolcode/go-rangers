// Copyright 2020 The RangersProtocol Authors
// This file is part of the RangersProtocol library.
//
// The RangersProtocol library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The RangersProtocol library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the RangersProtocol library. If not, see <http://www.gnu.org/licenses/>.

package vm

import (
	"com.tuntun.rangers/node/src/common"
	"com.tuntun.rangers/node/src/middleware/log"
	"fmt"
	"math/big"
	"os"
	"strconv"
	"testing"
	"time"
)

var base = "0x8e900fd2"

func TestMaxHash(t *testing.T) {
	h := common.HexToHash("1fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff")
	nonce := new(big.Int).SetBytes(h.Bytes()[:20]).String()
	fmt.Println(nonce)
	fmt.Println(len(nonce))
}

func TestNode(t *testing.T) {
	os.RemoveAll("storage0")
	os.RemoveAll("1.ini")

	mockInit()
	config := new(testConfig)
	setDefaults(config)
	defer log.Close()

	source := "0x826f575031a074fd914a869b5dc1c4eae620fef5"
	config.CanTransfer = CanTransfer
	config.Transfer = Transfer
	config.GetHashFn = func(uint64) common.Hash { return common.Hash{} }

	config.Origin = common.HexToAddress(source)
	config.Coinbase = common.HexToAddress(source)
	config.BlockNumber = new(big.Int).SetUint64(0)
	config.Time = new(big.Int).SetUint64(uint64(time.Now().Unix()))

	config.Origin = common.HexToAddress("0x826f575031a074fd914a869b5dc1c4eae620fef5")
	stateDB := config.State
	stateDB.SetBalance(config.Origin, big.NewInt(5))
	config.GasPrice = big.NewInt(1)
	config.GasLimit = 30000000

	minerstake := common.FromHex("608060405234801561001057600080fd5b50613586806100206000396000f3fe6080604052600436106101a05760003560e01c8063b1f4e514116100ec578063d78235881161008a578063de65256e11610064578063de65256e146105b0578063dfc9bbf6146105c5578063f14d87dd146105da578063f2b190ab14610604576101f5565b8063d782358814610547578063d8e136e214610571578063da5a22311461059b576101f5565b8063cf5fbb38116100c6578063cf5fbb381461049c578063d06d648c146104cf578063d2785837146104f9578063d2f0013e14610532576101f5565b8063b1f4e51414610446578063bacea65b1461048c578063c4035e3514610494576101f5565b80636a1c5bd011610159578063917155ec11610133578063917155ec146103b6578063927cc064146103cb5780639f3abf28146103fe578063a331f78d14610431576101f5565b80636a1c5bd01461031b57806386863ec6146103305780638f005ba214610373576101f5565b80630c7ef9321461024a5780630fc14774146102705780631fd09689146102a05780632cc0c124146102c757806343752e8e146102dc5780634ee97a1a14610306576101f5565b366101f557600034116101f3576040805162461bcd60e51b815260206004820152601660248201527572656365697665206d757374206861732076616c756560501b604482015290519081900360640190fd5b005b600034116101f3576040805162461bcd60e51b815260206004820152601760248201527f66616c6c6261636b206d757374206861732076616c7565000000000000000000604482015290519081900360640190fd5b6101f36004803603602081101561026057600080fd5b50356001600160a01b031661065b565b34801561027c57600080fd5b506101f36004803603604081101561029357600080fd5b508035906020013561091e565b3480156102ac57600080fd5b506102b5610a3e565b60408051918252519081900360200190f35b3480156102d357600080fd5b506101f3610a44565b3480156102e857600080fd5b506101f3600480360360208110156102ff57600080fd5b5035610bee565b34801561031257600080fd5b506102b5610d1f565b34801561032757600080fd5b506102b5610d25565b34801561033c57600080fd5b506101f36004803603606081101561035357600080fd5b506001600160a01b03813581169160208101359091169060400135610d2b565b34801561037f57600080fd5b5061039d6004803603602081101561039657600080fd5b5035610e76565b6040805192835260208301919091528051918290030190f35b3480156103c257600080fd5b506102b5610ea4565b3480156103d757600080fd5b506101f3600480360360208110156103ee57600080fd5b50356001600160a01b0316610eaa565b34801561040a57600080fd5b506101f36004803603602081101561042157600080fd5b50356001600160a01b0316611005565b34801561043d57600080fd5b5061039d61116f565b34801561045257600080fd5b506104706004803603602081101561046957600080fd5b5035611242565b604080516001600160a01b039092168252519081900360200190f35b6101f361126c565b6101f3611665565b3480156104a857600080fd5b5061039d600480360360208110156104bf57600080fd5b50356001600160a01b0316611b6b565b3480156104db57600080fd5b506102b5600480360360208110156104f257600080fd5b5035611d2e565b34801561050557600080fd5b5061039d6004803603604081101561051c57600080fd5b506001600160a01b038135169060200135611d4f565b34801561053e57600080fd5b50610470611d8b565b34801561055357600080fd5b506101f36004803603602081101561056a57600080fd5b5035611d9a565b34801561057d57600080fd5b506104706004803603602081101561059457600080fd5b5035611ecf565b3480156105a757600080fd5b50610470611edf565b3480156105bc57600080fd5b506102b5611eee565b3480156105d157600080fd5b506101f3611ef4565b3480156105e657600080fd5b506102b5600480360360208110156105fd57600080fd5b5035612464565b34801561061057600080fd5b5061063d6004803603604081101561062757600080fd5b506001600160a01b038135169060200135612474565b60408051938452602084019290925282820152519081900360600190f35b6001600160a01b0381166106aa576040805162461bcd60e51b815260206004820152601160248201527021b630b4b6902fb0b232391032b93937b960791b604482015290519081900360640190fd5b600080805b336000908152600c60205260409020548110156107a957336000908152600c602052604090208054618ca09161070a91849081106106e957fe5b906000526020600020906002020160010154436124b690919063ffffffff16565b1061074e57336000908152600c60205260409020805461074791908390811061072f57fe5b600091825260209091206002909102015483906124d0565b91506107a1565b336000908152600c6020526040902080548491908390811061076c57fe5b600091825260208083208454600181810187559585529190932060029283029093018054919092029092019182558201549101555b6001016106af565b50600081116107b957505061091b565b815461086257336000908152600c602052604081206107d791613209565b60005b600b5481101561085c57336001600160a01b0316600b82815481106107fb57fe5b6000918252602090912001546001600160a01b03161415610854576000600b828154811061082557fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6001016107da565b50610881565b336000908152600c60205260409020825461087f9190849061322a565b505b6040516001600160a01b0384169082156108fc029083906000818181858888f193505050501580156108b7573d6000803e3d6000fd5b50604080516001600160a01b03851681526020810183905281517f664e3a5109f43051dae9a2b55c03407adaa61f302efb53c077da6b44043fa02f929181900390910190a16002546001600160a01b031633141561091857610918836124e9565b50505b50565b6006546001600160a01b0316331461097d576040805162461bcd60e51b815260206004820152601d60248201527f4368616e6765506572696f64206f6e6c792073657420627920726f6f74000000604482015290519081900360640190fd5b816109b95760405162461bcd60e51b815260040180806020018281038252602481526020018061336c6024913960400191505060405180910390fd5b806109f55760405162461bcd60e51b81526004018080602001828103825260268152602001806134786026913960400191505060405180910390fd5b60078290556008819055604080518381526020810183905281517f33dae5695f66eeee7dd304fb4fef60cb0186a9f47b5757dd9fda831d56bf4f5a929181900390910190a15050565b600f5481565b6006546001600160a01b03163314610aa3576040805162461bcd60e51b815260206004820152601b60248201527f47657450726f666974206f6e6c792063616c6c20627920726f6f740000000000604482015290519081900360640190fd5b600060055411610ae45760405162461bcd60e51b815260040180806020018281038252602781526020018061342b6027913960400191505060405180910390fd5b610aec6126c4565b6000805b600954811015610b6b5760006001600160a01b031660098281548110610b1257fe5b6000918252602090912001546001600160a01b031614610b6357610b60610b5960098381548110610b3f57fe5b6000918252602090912001546001600160a01b031661293b565b83906124d0565b91505b600101610af0565b50610b7461328a565b50604080518082019091529081524360208201908152600d805460018101825560009190915291517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb5600290930292830155517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb690910155565b600060055411610c45576040805162461bcd60e51b815260206004820152601d60248201527f536574506172616d73206572726f72203a206e6f742073746172746564000000604482015290519081900360640190fd5b6002546001600160a01b03163314610ca4576040805162461bcd60e51b815260206004820152601b60248201527f536574506172616d73206f6e6c79207365742062792061646d696e0000000000604482015290519081900360640190fd5b601e811115610ce45760405162461bcd60e51b81526004018080602001828103825260278152602001806133246027913960400191505060405180910390fd5b600e8190556040805182815290517fdfa0c5c2ff003a9528ac30ffd70d13630d360b26b9cfcb6455f4cb630bfa149e9181900360200190a150565b60075481565b60085481565b6006546001600160a01b031615610d82576040805162461bcd60e51b8152602060048201526016602482015275696e69742063616e206f6e6c792072756e206f6e636560501b604482015290519081900360640190fd5b600680546001600160a01b038086166001600160a01b0319928316179092556276a700600755620151806008556003600e819055678ac7230489e80000600f554260055560028054938616939092168317909155805460018181019092557fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b01839055600480549182018155600052437f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b90910155604080519182526020820183905280517fbde64498c29fbcf96b49024cc85edfa6e6b2eaf65f85aa68f0e5c1f9a00fa9049281900390910190a1505050565b600d8181548110610e8657600080fd5b60009182526020909120600290910201805460019091015490915082565b60055481565b6002546001600160a01b03163314610f09576040805162461bcd60e51b815260206004820152601d60248201527f4368616e676541646d696e206f6e6c79207365742062792061646d696e000000604482015290519081900360640190fd5b6001600160a01b038116610f64576040805162461bcd60e51b815260206004820152601760248201527f4368616e676541646d696e205f61646472206572726f72000000000000000000604482015290519081900360640190fd5b6002546001600160a01b0382811691161415610fb15760405162461bcd60e51b815260040180806020018281038252602181526020018061351e6021913960400191505060405180910390fd5b600280546001600160a01b0383166001600160a01b0319909116811790915560408051918252517f3a00189bcf95fc36fa1adad0441ee0c1abff5a27eb0f705d2c46c23dce3ddada9181900360200190a150565b6006546001600160a01b03163314611064576040805162461bcd60e51b815260206004820152601c60248201527f4368616e6765526f6f74206f6e6c79207365742062792061646d696e00000000604482015290519081900360640190fd5b6001600160a01b0381166110b8576040805162461bcd60e51b815260206004820152601660248201527521b430b733b2a937b7ba102fb0b232391032b93937b960511b604482015290519081900360640190fd5b6006546001600160a01b038281169116141561111b576040805162461bcd60e51b815260206004820181905260248201527f4368616e6765526f6f742063616e206e6f74207365742073616d652061646472604482015290519081900360640190fd5b600680546001600160a01b0383166001600160a01b0319909116811790915560408051918252517f485e105725a3db6421b009bc09fd232847ea51c19d56601a77ae150a4f577fcb9181900360200190a150565b6000806000805b336000908152600c60205260409020548110156111e057336000908152600c602052604090208054618ca0916111b091849081106106e957fe5b106111d857336000908152600c6020526040902080546111d591908390811061072f57fe5b91505b600101611176565b506002546000906001600160a01b03163314156112395760005b600d5481101561123757618ca0611217600d83815481106106e957fe5b1061122f5761122c600d828154811061072f57fe5b91505b6001016111fa565b505b90925090509091565b600b818154811061125257600080fd5b6000918252602090912001546001600160a01b0316905081565b6000600554116112c3576040805162461bcd60e51b815260206004820152601c60248201527f4465706f73697465206572726f72203a206e6f74207374617274656400000000604482015290519081900360640190fd5b600f5434101561131a576040805162461bcd60e51b815260206004820152601860248201527f4465706f73697465206d6f72652052504720706c656173650000000000000000604482015290519081900360640190fd5b61132c34670de0b6b3a7640000612bc1565b1561137e576040805162461bcd60e51b815260206004820152601c60248201527f4465706f7369746520726f756e64206e756d62657220706c6561736500000000604482015290519081900360640190fd5b6002546001600160a01b0316331415611449576003546113e0576815af1d78b58c4000003410156113e05760405162461bcd60e51b81526004018080602001828103825260248152602001806133bb6024913960400191505060405180910390fd5b600380546001818101909255347fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b90910155600480549182018155600052437f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b909101556115d9565b6000600019815b6009548110156114e15760006001600160a01b03166009828154811061147257fe5b6000918252602090912001546001600160a01b0316148015611495575060001982145b1561149e578091505b336001600160a01b0316600982815481106114b557fe5b6000918252602090912001546001600160a01b031614156114d957600192506114e1565b600101611450565b50816115745760001981146115315733600982815481106114fe57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550611574565b600980546001810182556000919091527f6e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7af0180546001600160a01b031916331790555b61157c6132a4565b505060408051606081018252348152436020808301918252600e54838501908152336000908152600a8352948520805460018181018355918752929095209351600390920290930190815590519281019290925551600290910155505b3034ee1515600114611629576040805162461bcd60e51b81526020600482015260146024820152732232b837b9b4ba329039ba30b5b29032b93937b960611b604482015290519081900360640190fd5b6040805133815234602082015281517fbde64498c29fbcf96b49024cc85edfa6e6b2eaf65f85aa68f0e5c1f9a00fa904929181900390910190a1565b600080600061167333612bde565b905061167e33612cb2565b60025491945092506001600160a01b03163314156118b85760055415806116c757506008546116c46007546116be600554426124b690919063ffffffff16565b90612bc1565b11155b6117025760405162461bcd60e51b81526004018080602001828103825260268152602001806134526026913960400191505060405180910390fd5b3081ef151560011461175b576040805162461bcd60e51b815260206004820152601c60248201527f61646d696e20576974686472617720756e7374616b65206572726f7200000000604482015290519081900360640190fd5b6000600019815b600b548110156117f35760006001600160a01b0316600b828154811061178457fe5b6000918252602090912001546001600160a01b03161480156117a7575060001982145b156117b0578091505b336001600160a01b0316600b82815481106117c757fe5b6000918252602090912001546001600160a01b031614156117eb57600192506117f3565b600101611762565b50816118745760001981146118435733600b828154811061181057fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550611874565b600b805460018101825560009190915260008051602061340b8339815191520180546001600160a01b031916331790555b600354600019015b6003818154811061188957fe5b9060005260206000200160009055600481815481106118a457fe5b60009182526020822001556000190161187c565b600081116118c857505050611b69565b3081ef151560011461191a576040805162461bcd60e51b81526020600482015260166024820152752bb4ba34323930bb903ab739ba30b5b29032b93937b960511b604482015290519081900360640190fd5b6000600019815b600b548110156119b25760006001600160a01b0316600b828154811061194357fe5b6000918252602090912001546001600160a01b0316148015611966575060001982145b1561196f578091505b336001600160a01b0316600b828154811061198657fe5b6000918252602090912001546001600160a01b031614156119aa57600192506119b2565b600101611921565b5081611a33576000198114611a025733600b82815481106119cf57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550611a33565b600b805460018101825560009190915260008051602061340b8339815191520180546001600160a01b031916331790555b611a3b61328a565b6040805180820190915280611a5086896124d0565b815243602091820152336000908152600c8252604081208054600181810183559183529183902084516002909302019182559183015191015590508415611b1257611a9961328a565b50604080518082019091528581524360208201908152600d805460018101825560009190915291517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb5600290930292830155517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb6909101555b611b1b336130c5565b50505060408051338152602081018390528082018590526060810184905290517f9c949dc88f7bbc30f196e0c9a134473342e6e79fd3220c1db685a4c7d6beebc19181900360800190a15050505b565b6000806001600160a01b038316611bc1576040805162461bcd60e51b815260206004820152601560248201527423b2ba2932bbb0b932102fb0b232391032b93937b960591b604482015290519081900360640190fd5b600080611bcd85612cb2565b90925090506000805b6001600160a01b0387166000908152600c6020526040902054811015611c29576001600160a01b0387166000908152600c602052604090208054611c1f91908390811061072f57fe5b9150600101611bd6565b506002546001600160a01b0387811691161415611d15576000805b600d54811015611c6857611c5e600d828154811061072f57fe5b9150600101611c44565b506000805b600954811015611cef5760006001600160a01b031660098281548110611c8f57fe5b6000918252602090912001546001600160a01b031614611ce7576000611cd560098381548110611cbb57fe5b6000918252602090912001546001600160a01b0316612cb2565b9150611ce3905083826124d0565b9250505b600101611c6d565b50611cfa85846124d0565b945084611d0783836124d0565b965096505050505050611d29565b611d1f83826124d0565b6000945094505050505b915091565b60038181548110611d3e57600080fd5b600091825260209091200154905081565b600c6020528160005260406000208181548110611d6b57600080fd5b600091825260209091206002909102018054600190910154909250905082565b6006546001600160a01b031681565b600060055411611ddb5760405162461bcd60e51b815260040180806020018281038252602181526020018061334b6021913960400191505060405180910390fd5b6002546001600160a01b03163314611e3a576040805162461bcd60e51b815260206004820152601f60248201527f536574506172616d4c696d6974206f6e6c79207365742062792061646d696e00604482015290519081900360640190fd5b600081118015611e595750611e5781670de0b6b3a7640000612bc1565b155b611e945760405162461bcd60e51b815260040180806020018281038252602d81526020018061349e602d913960400191505060405180910390fd5b600f8190556040805182815290517fb5a976a037fa8c99049961141671394201c185ac0856907a41c370c81cb844909181900360200190a150565b6009818154811061125257600080fd5b6002546001600160a01b031681565b600e5481565b6006546001600160a01b03163314611f53576040805162461bcd60e51b815260206004820152601f60248201527f556e64656c6567617465416c6c206f6e6c792063616c6c20627920726f6f7400604482015290519081900360640190fd5b60025460009081908190611f6f906001600160a01b0316612bde565b600254909150611f87906001600160a01b0316612cb2565b90935091503081ef1515600114611fcf5760405162461bcd60e51b815260040180806020018281038252602a8152602001806134f4602a913960400191505060405180910390fd5b6000600019815b600b5481101561206d5760006001600160a01b0316600b8281548110611ff857fe5b6000918252602090912001546001600160a01b031614801561201b575060001982145b15612024578091505b600254600b80546001600160a01b03909216918390811061204157fe5b6000918252602090912001546001600160a01b03161415612065576001925061206d565b600101611fd6565b508161210d5760001981146120cc57600254600b80546001600160a01b03909216918390811061209957fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555061210d565b600254600b805460018101825560009190915260008051602061340b8339815191520180546001600160a01b0319166001600160a01b039092169190911790555b600354600019015b6003818154811061212257fe5b90600052602060002001600090556004818154811061213d57fe5b600091825260208220015560001901612115565b60095481101561245e5760006009828154811061216a57fe5b6000918252602090912001546001600160a01b031690508061218c5750612456565b61219581612bde565b92506121a081612cb2565b9095509350846121b05750612456565b3083ef15156001146121f35760405162461bcd60e51b81526004018080602001828103825260298152602001806134cb6029913960400191505060405180910390fd5b6000600019815b600b5481101561228b5760006001600160a01b0316600b828154811061221c57fe5b6000918252602090912001546001600160a01b031614801561223f575060001982145b15612248578091505b836001600160a01b0316600b828154811061225f57fe5b6000918252602090912001546001600160a01b03161415612283576001925061228b565b6001016121fa565b50816123155760001981146122db5782600b82815481106122a857fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550612315565b600b805460018101825560009190915260008051602061340b8339815191520180546001600160a01b0319166001600160a01b0385161790555b61231d61328a565b6040805180820190915280612332888b6124d0565b8152436020918201526001600160a01b0386166000908152600c82526040812080546001818101835591835291839020845160029093020191825591830151910155905061237e61328a565b50604080518082019091528781524360208201908152600d805460018101825560009190915282517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb560029092029182015590517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb690910155612400856130c5565b604080516001600160a01b0387168152602081018990528082018b9052606081018a905290517f9c949dc88f7bbc30f196e0c9a134473342e6e79fd3220c1db685a4c7d6beebc19181900360800190a150505050505b600101612151565b50505050565b60048181548110611d3e57600080fd5b600a602052816000526040600020818154811061249057600080fd5b600091825260209091206003909102018054600182015460029092015490935090915083565b6000828211156124c557600080fd5b508082035b92915050565b6000828201838110156124e257600080fd5b9392505050565b6002546001600160a01b03163314612548576040805162461bcd60e51b815260206004820152601b60248201527f436c61696d466565206f6e6c792063616c6c2062792061646d696e0000000000604482015290519081900360640190fd5b6001600160a01b03811661259a576040805162461bcd60e51b815260206004820152601460248201527321b630b4b6a332b2902fb0b232391032b93937b960611b604482015290519081900360640190fd5b600080805b600d5481101561262357618ca06125bc600d83815481106106e957fe5b106125d8576125d1600d828154811061072f57fe5b915061261b565b82600d82815481106125e657fe5b600091825260208083208454600181810187559585529190932060029283029093018054919092029092019182558201549101555b60010161259f565b506000811161263357505061091b565b815461264390600d90849061322a565b506040516001600160a01b0384169082156108fc029083906000818181858888f1935050505015801561267a573d6000803e3d6000fd5b50604080516001600160a01b03851681526020810183905281517fde99e8d5ae50168bd0e8da7b27963feeaeb46af917be4f37a74148b6d4d00101929181900390910190a1505050565b6000600554116127055760405162461bcd60e51b815260040180806020018281038252602c8152602001806133df602c913960400191505060405180910390fd5b600254600090819061271f906001600160a01b0316612cb2565b90925090506000600019815b600b548110156127c25760006001600160a01b0316600b828154811061274d57fe5b6000918252602090912001546001600160a01b0316148015612770575060001982145b15612779578091505b600254600b80546001600160a01b03909216918390811061279657fe5b6000918252602090912001546001600160a01b031614156127ba57600192506127c2565b60010161272b565b508161286257600019811461282157600254600b80546001600160a01b0390921691839081106127ee57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550612862565b600254600b805460018101825560009190915260008051602061340b8339815191520180546001600160a01b0319166001600160a01b039092169190911790555b61286a61328a565b50604080518082018252858152436020808301918252600280546001600160a01b03166000908152600c83529485208054600181810183559187529286208551939092029091019182559151910155905b6004548110156128e75743600482815481106128d357fe5b6000918252602090912001556001016128bb565b50600254604080516001600160a01b03909216825260208201879052600082820152517fc3dcd5591a9a5c937be27ea67a07571e7251392216a8e16f7fd1f2bf0c5a559d9181900360600190a15050505050565b6000806005541161297d5760405162461bcd60e51b815260040180806020018281038252602b815260200180613390602b913960400191505060405180910390fd5b60008061298984612cb2565b90925090506000600019815b600b54811015612a265760006001600160a01b0316600b82815481106129b757fe5b6000918252602090912001546001600160a01b03161480156129da575060001982145b156129e3578091505b866001600160a01b0316600b82815481106129fa57fe5b6000918252602090912001546001600160a01b03161415612a1e5760019250612a26565b600101612995565b5081612ab0576000198114612a765785600b8281548110612a4357fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550612ab0565b600b805460018101825560009190915260008051602061340b8339815191520180546001600160a01b0319166001600160a01b0388161790555b612ab861328a565b506040805180820182528581524360208083019182526001600160a01b038a166000908152600c825293842080546001818101835591865291852084516002909302019182559151910155905b6001600160a01b0388166000908152600a6020526040902054811015612b6a576001600160a01b0388166000908152600a60205260409020805443919083908110612b4c57fe5b60009182526020909120600160039092020181019190915501612b05565b50604080516001600160a01b03891681526020810187905280820186905290517fc3dcd5591a9a5c937be27ea67a07571e7251392216a8e16f7fd1f2bf0c5a559d9181900360600190a1509193505050505b919050565b600081612bcd57600080fd5b818381612bd657fe5b069392505050565b6002546000906001600160a01b0383811691161415612c3e5760005b600354811015612c3857612c2e60038281548110612c1457fe5b9060005260206000200154836124d090919063ffffffff16565b9150600101612bfa565b50612bbc565b60005b6001600160a01b0383166000908152600a6020526040902054811015612cac576001600160a01b0383166000908152600a602052604090208054612ca2919083908110612c8a57fe5b600091825260209091206003909102015483906124d0565b9150600101612c41565b50919050565b600080600080600043905060008060008060038054905060001415612cd5575060015b60005b600354811015612d4157612d37612d3060038381548110612cf557fe5b9060005260206000200154612d2a60048581548110612d1057fe5b90600052602060002001548a6124b690919063ffffffff16565b906131c0565b85906124d0565b9350600101612cd8565b5082935060005b600954811015612f655760005b600a600060098481548110612d6657fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902054811015612f5c576000612e54612dfc600a600060098781548110612dab57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805485908110612ddb57fe5b9060005260206000209060030201600101548a6124b690919063ffffffff16565b600a600060098781548110612e0d57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805485908110612e3d57fe5b6000918252602090912060039091020154906131c0565b9050612e6087826124d0565b96508c6001600160a01b031660098481548110612e7957fe5b6000918252602090912001546001600160a01b03161415612f535760018415151415612eb057612ea985826124d0565b9450612f53565b6000612f2d6064612f27612f20600a600060098a81548110612ece57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805488908110612efe57fe5b90600052602060002090600302016002015460646124b690919063ffffffff16565b85906131c0565b906131e7565b9050612f3986826124d0565b9550612f4f612f4883836124b6565b8b906124d0565b9950505b50600101612d55565b50600101612d48565b506000805b600b548110156130235760005b600c6000600b8481548110612f8857fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205481101561301a57613010600c6000600b8581548110612fc857fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805483908110612ff857fe5b600091825260209091206002909102015484906124d0565b9250600101612f77565b50600101612f6a565b506000805b600d5481101561304c57613042600d828154811061072f57fe5b9150600101613028565b5060006130638261305d47866124b6565b906124b6565b6002549091506001600160a01b038e8116911614156130915761308a87612f2783896131c0565b99506130b2565b61309f87612f2783886131c0565b99506130af87612f27838c6131c0565b98505b5097995095975050505050505050915091565b6001600160a01b038116613115576040805162461bcd60e51b81526020600482015260126024820152713232b63ab9b2b9103830b9309032b93937b960711b604482015290519081900360640190fd5b60005b60095481101561319e57336001600160a01b03166009828154811061313957fe5b6000918252602090912001546001600160a01b031614156131965760006009828154811061316357fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555061319e565b600101613118565b506001600160a01b0381166000908152600a6020526040812061091b916132c5565b6000826131cf575060006124ca565b828202828482816131dc57fe5b04146124e257600080fd5b60008082116131f557600080fd5b600082848161320057fe5b04949350505050565b508054600082556002029060005260206000209081019061091b91906132e6565b82805482825590600052602060002090600202810192821561327a5760005260206000209160020282015b8281111561327a57825482556001808401549083015560029283019290910190613255565b506132869291506132e6565b5090565b604051806040016040528060008152602001600081525090565b60405180606001604052806000815260200160008152602001600081525090565b508054600082556003029060005260206000209081019061091b9190613301565b5b8082111561328657600080825560018201556002016132e7565b5b8082111561328657600080825560018201819055600282015560030161330256fe536574506172616d73205f66656570657263656e74206f6e6c792063616e2073657420302d3330536574506172616d4c696d6974206572726f72203a206e6f7420737461727465644368616e6765506572696f64205f61646d696e6c696d6974706572696f64206572726f725573657247657450726f6669742063616e206e6f742063616c6c207768656e206e6f7420737461727465644465706f736974652061646d696e207265616464206d757374203e3d203430302052504741646d696e47657450726f6669742063616e206e6f742063616c6c207768656e206e6f7420737461727465640175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db947657450726f6669742063616e206e6f742063616c6c207768656e206e6f74207374617274656457697468647261772c2061646d696e206e6f7420696e20776974686472617720706572696f644368616e6765506572696f64205f61646d696e72656c65617365706572696f64206572726f72536574506172616d4c696d6974205f7374616b656c696d697420726f756e64206e756d62657220706c65617365556e64656c6567617465416c6c207573657220576974686472617720756e7374616b65206572726f72556e64656c6567617465416c6c2061646d696e20576974686472617720756e7374616b65206572726f724368616e676541646d696e2063616e206e6f74207365742073616d652061646472a26469706673582212206b5e0f58b1102acf04a385eb78c2a0e788bb3cba91f78dbab810608bdabea51964736f6c6375302e372e352b636f6d6d69742e65623737656430380045")
	maincontract := common.FromHex("608060405234801561001057600080fd5b50610e0b806100206000396000f3fe6080604052600436106100865760003560e01c8063487b28dd11610059578063487b28dd1461012c57806349cf442d1461015f578063a688c77414610188578063bfa0b1331461019d578063eefb6127146101c457610086565b80630156e97c1461008b5780632f887436146100bc57806337ad78be146100f1578063412a5a6d14610124575b600080fd5b34801561009757600080fd5b506100a06101d9565b604080516001600160a01b039092168252519081900360200190f35b3480156100c857600080fd5b506100ef600480360360208110156100df57600080fd5b50356001600160a01b03166101e8565b005b3480156100fd57600080fd5b506100ef6004803603602081101561011457600080fd5b50356001600160a01b03166102d0565b6100ef6103b8565b34801561013857600080fd5b506100ef6004803603602081101561014f57600080fd5b50356001600160a01b0316610787565b34801561016b57600080fd5b5061017461086f565b604080519115158252519081900360200190f35b34801561019457600080fd5b506100a0610880565b3480156101a957600080fd5b506101b261088f565b60408051918252519081900360200190f35b3480156101d057600080fd5b506100a0610895565b6002546001600160a01b031681565b6001546001600160a01b031633146102315760405162461bcd60e51b815260040180806020018281038252602c815260200180610cca602c913960400191505060405180910390fd5b6001600160a01b0381166102765760405162461bcd60e51b8152600401808060200182810382526024815260200180610d756024913960400191505060405180910390fd5b600380546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517fbb10f32d2cf07186fa28534b858fdf961e6669e108dee6505d08ac2a30f737a6916020908290030190a150565b6001546001600160a01b031633146103195760405162461bcd60e51b815260040180806020018281038252602a815260200180610cf6602a913960400191505060405180910390fd5b6001600160a01b03811661035e5760405162461bcd60e51b8152600401808060200182810382526022815260200180610d206022913960400191505060405180910390fd5b600480546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517f559dd1d6b0f4bce6fd0230a673cc24ef5caa836da5852a82aba08d0da27222f2916020908290030190a150565b6103c061086f565b6103c957600080fd5b60055460003380ec91506815af1d78b58c4000008210156103e957600080fd5b6060604051806020016103fb906108a4565b6020820181038252601f19601f820116604052509050600081518581602085016000f5915050803b61042c57600080fd5b600254604080516001600160a01b0392831660248083019190915282518083039091018152604490910182526020810180516001600160e01b031662900f0160e41b178152915181519193600093606093918716928692909182918083835b602083106104aa5780518252601f19909201916020918201910161048b565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d806000811461050c576040519150601f19603f3d011682016040523d82523d6000602084013e610511565b606091505b50915091508161052057600080fd5b604080513360248083019190915282518083039091018152604490910182526020810180516001600160e01b031663198b93b960e21b178152915181519195506001600160a01b0387169286928291908083835b602083106105935780518252601f199092019160209182019101610574565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d80600081146105f5576040519150601f19603f3d011682016040523d82523d6000602084013e6105fa565b606091505b5090925090508161060a57600080fd5b600454604080516001600160a01b039283166024820152888316604482015260648082018b905282518083039091018152608490910182526020810180516001600160e01b03166343431f6360e11b1781529151815191965092871692869290918291908083835b602083106106915780518252601f199092019160209182019101610672565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d80600081146106f3576040519150601f19603f3d011682016040523d82523d6000602084013e6106f8565b606091505b5090925090508161070857600080fd5b600554600254600454604080516001600160a01b03808a1682526020820195909552928416838201529083166060830152918816608082015260a0810189905290517f511714af7f49b22f62f305f2a4208335e424d7b17891553b204351db703cf9c89181900360c00190a15050600580546001019055505050505050565b6001546001600160a01b031633146107d05760405162461bcd60e51b8152600401808060200182810382526033815260200180610d426033913960400191505060405180910390fd5b6001600160a01b0381166108155760405162461bcd60e51b815260040180806020018281038252602b815260200180610d99602b913960400191505060405180910390fd5b600280546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517fdc1b03aa7118707aafb4044faaf6670a730f5cf9db870157f5ce90ad6c9df4ea916020908290030190a150565b6003546001600160a01b0316331490565b6004546001600160a01b031681565b60055481565b6003546001600160a01b031681565b610418806108b28339019056fe608060405234801561001057600080fd5b50600180546001600160a01b031916331790556103e6806100326000396000f3fe60806040526004361061004e5760003560e01c80630900f01014610099578063662e4ee4146100ce5780638da5cb5b146101015780638f32d59b14610132578063b62654fb1461015b57610055565b3661005557005b600080546001600160a01b0316813563530ca43760e11b141561007a57808252602082f35b3682833781823684845af490503d82833e80610094573d82fd5b503d81f35b3480156100a557600080fd5b506100cc600480360360208110156100bc57600080fd5b50356001600160a01b0316610170565b005b3480156100da57600080fd5b506100cc600480360360208110156100f157600080fd5b50356001600160a01b031661027e565b34801561010d57600080fd5b50610116610344565b604080516001600160a01b039092168252519081900360200190f35b34801561013e57600080fd5b50610147610353565b604080519115158252519081900360200190f35b34801561016757600080fd5b50610116610364565b610178610353565b61018157600080fd5b6001600160a01b0381166101d2576040805162461bcd60e51b8152602060048201526013602482015272757067726164652077726f6e6720706172616d60681b604482015290519081900360640190fd5b6101e4816001600160a01b0316610373565b15156001146102245760405162461bcd60e51b815260040180806020018281038252602581526020018061037a6025913960400191505060405180910390fd5b600080546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517fdf4e60358b29f369ae3e62e25ba3b229bab738ad23e057ef063141c7ef559814916020908290030190a150565b610286610353565b61028f57600080fd5b6001600160a01b0381166102ea576040805162461bcd60e51b815260206004820152601760248201527f6368616e67656f776e65722077726f6e6720706172616d000000000000000000604482015290519081900360640190fd5b600180546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517f6972f954346c124a4639edfe943e82b1c2d812116e4a30822027087767f745a2916020908290030190a150565b6001546001600160a01b031681565b6001546001600160a01b0316331490565b6000546001600160a01b031681565b3b15159056fe757067726164652061646472206d75737420626520636f6e74726163742061646472657373a26469706673582212201711a754ffed86291131180e07a6508425ada689271845d9ca3acb26445d846e64736f6c6375302e372e352b636f6d6d69742e656237376564303800454d61696e436f6e74726163742075706461746563616c6c6572206d7573742063616c6c206279206f776e65724d61696e436f6e747261637420757064617465726f6f74206d7573742063616c6c206279206f776e65724d61696e436f6e747261637420757064617465726f6f742070617261206572726f724d61696e436f6e7472616374207570646174656c6f676963636f6e7472616374206d7573742063616c6c206279206f776e65724d61696e436f6e74726163742075706461746563616c6c65722070617261206572726f724d61696e436f6e7472616374207570646174656c6f676963636f6e74726163742070617261206572726f72a2646970667358221220e7f15bb177d273ceef9e22f641d6a5369ed80c3e7d4795a4dbdffd8a5afa6acc64736f6c6375302e372e352b636f6d6d69742e65623737656430380045")
	proxycontract := common.FromHex("608060405234801561001057600080fd5b50600180546001600160a01b031916331790556103e6806100326000396000f3fe60806040526004361061004e5760003560e01c80630900f01014610099578063662e4ee4146100ce5780638da5cb5b146101015780638f32d59b14610132578063b62654fb1461015b57610055565b3661005557005b600080546001600160a01b0316813563530ca43760e11b141561007a57808252602082f35b3682833781823684845af490503d82833e80610094573d82fd5b503d81f35b3480156100a557600080fd5b506100cc600480360360208110156100bc57600080fd5b50356001600160a01b0316610170565b005b3480156100da57600080fd5b506100cc600480360360208110156100f157600080fd5b50356001600160a01b031661027e565b34801561010d57600080fd5b50610116610344565b604080516001600160a01b039092168252519081900360200190f35b34801561013e57600080fd5b50610147610353565b604080519115158252519081900360200190f35b34801561016757600080fd5b50610116610364565b610178610353565b61018157600080fd5b6001600160a01b0381166101d2576040805162461bcd60e51b8152602060048201526013602482015272757067726164652077726f6e6720706172616d60681b604482015290519081900360640190fd5b6101e4816001600160a01b0316610373565b15156001146102245760405162461bcd60e51b815260040180806020018281038252602581526020018061037a6025913960400191505060405180910390fd5b600080546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517fdf4e60358b29f369ae3e62e25ba3b229bab738ad23e057ef063141c7ef559814916020908290030190a150565b610286610353565b61028f57600080fd5b6001600160a01b0381166102ea576040805162461bcd60e51b815260206004820152601760248201527f6368616e67656f776e65722077726f6e6720706172616d000000000000000000604482015290519081900360640190fd5b600180546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517f6972f954346c124a4639edfe943e82b1c2d812116e4a30822027087767f745a2916020908290030190a150565b6001546001600160a01b031681565b6001546001600160a01b0316331490565b6000546001600160a01b031681565b3b15159056fe757067726164652061646472206d75737420626520636f6e74726163742061646472657373a26469706673582212201711a754ffed86291131180e07a6508425ada689271845d9ca3acb26445d846e64736f6c6375302e372e352b636f6d6d69742e65623737656430380045")

	_, minerstakeAddress, createLeftGas, createErr := mockCreate(minerstake, config)
	fmt.Printf("New create minerstake address:%s\n", minerstakeAddress.GetHexString())
	fmt.Printf("New create minerstake costGas: %v,createErr:%v\n", config.GasLimit-createLeftGas, createErr)

	_, maincontractAddress, createLeftGas, createErr := mockCreate(maincontract, config)
	fmt.Printf("New create maincontract address:%s\n", maincontractAddress.GetHexString())
	fmt.Printf("New create maincontract costGas: %v,createErr: %v\n", config.GasLimit-createLeftGas, createErr)

	_, proxyAddress, createLeftGas, createErr := mockCreate(proxycontract, config)
	fmt.Printf("New create proxyAddress address:%s\n", proxyAddress.GetHexString())
	fmt.Printf("New create maincontract costGas: %v,createErr: %v\n", config.GasLimit-createLeftGas, createErr)

	proxyinput := "0x0900f010000000000000000000000000" + maincontractAddress.GetHexString()[2:]
	callResult, callLeftGas, callErr := mockCall(proxyAddress, common.FromHex(proxyinput), config)
	fmt.Printf("callResult: %v,costGas: %d,callErr: %v\n", callResult, config.GasLimit-callLeftGas, callErr)

	maincontractinput := "0x487b28dd000000000000000000000000" + minerstakeAddress.GetHexString()[2:]
	callResult, callLeftGas, callErr = mockCall(proxyAddress, common.FromHex(maincontractinput), config)
	fmt.Printf("callResult: %v,costGas: %d,callErr: %v\n", callResult, config.GasLimit-callLeftGas, callErr)

	callResult, callLeftGas, callErr = mockCall(proxyAddress, common.FromHex("0x2f887436000000000000000000000000f89eebcc07e820f5a8330f52111fa51dd9dfb925"), config)
	fmt.Printf("callResult: %v,costGas: %d,callErr: %v\n", callResult, config.GasLimit-callLeftGas, callErr)

	callResult, callLeftGas, logs, callErr := mockCallWithLogs(proxyAddress, common.FromHex("0x412a5a6d"), config)
	fmt.Printf("callResult: %v,costGas: %d,callErr: %v\n", callResult, config.GasLimit-callLeftGas, callErr)
	fmt.Println(len(logs))

	//
	//input := generateCall(1, minerstakeAddress)
	//callResult, callLeftGas, logs, callErr := mockCallWithLogs(maincontractAddress, input, config)
	//fmt.Printf("callResult: %v,costGas: %d,callErr: %v\n", callResult, config.GasLimit-callLeftGas, callErr)
	//
	//if 3 != len(logs) {
	//	t.Fatal("wrong length")
	//}
	//log := logs[2]
	//realAddress := common.BytesToAddress(log.Data[:32])
	//fmt.Println("real address: " + realAddress.String())
}

func generateCall(salt int, address common.Address) []byte {
	saltString := strconv.Itoa(salt)
	length := len(saltString)
	if length > 64 {
		return nil
	}
	pad := ""
	for i := 0; i < (64 - length); i++ {
		pad = "0" + pad
	}

	addressString := address.String()
	inputString := fmt.Sprintf("0x8e900fd2%s%s000000000000000000000000%s", pad, saltString, addressString[2:])
	return common.FromHex(inputString)
}

func TestNodeResult(t *testing.T) {
	dataHex := "0x000000000000000000000000a495e75de1c8f06fcde1bb6cca7c52c94f1c3e690000000000000000000000000000000000000000000000000000000000000000000000000000000000000000df764badfdf3c27753f9c4a269a850d028f01dbc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000025716527aad0ae1dd24bd247af9232dae78595b0000000000000000000000000000000000000000000000015af1d78b58c400000"
	data := common.FromHex(dataHex)

	realAddress := data[12:32]

	fmt.Println(common.ToHex(realAddress))
	fmt.Println(common.BytesToAddress(data[:32]))

}
