package vm

import (
	"com.tuntun.rocket/node/src/common"
	"com.tuntun.rocket/node/src/middleware/log"
	"fmt"
	"math/big"
	"os"
	"strconv"
	"testing"
	"time"
)

var base = "0x8e900fd2"

func TestMaxHash(t *testing.T) {
	h := common.HexToHash("1fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff")
	nonce := new(big.Int).SetBytes(h.Bytes()[:20]).String()
	fmt.Println(nonce)
	fmt.Println(len(nonce))
}

func TestNode(t *testing.T) {
	os.RemoveAll("storage0")
	os.RemoveAll("1.ini")

	mockInit()
	config := new(testConfig)
	setDefaults(config)
	defer log.Close()

	source := "0x826f575031a074fd914a869b5dc1c4eae620fef5"
	config.CanTransfer = CanTransfer
	config.Transfer = Transfer
	config.GetHashFn = func(uint64) common.Hash { return common.Hash{} }

	config.Origin = common.HexToAddress(source)
	config.Coinbase = common.HexToAddress(source)
	config.BlockNumber = new(big.Int).SetUint64(0)
	config.Time = new(big.Int).SetUint64(uint64(time.Now().Unix()))

	config.Origin = common.HexToAddress("0x826f575031a074fd914a869b5dc1c4eae620fef5")
	stateDB := config.State
	stateDB.SetBalance(config.Origin, big.NewInt(5))
	config.GasPrice = big.NewInt(1)
	config.GasLimit = 30000000

	minerstake := common.FromHex("608060405234801561001057600080fd5b506134ab806100206000396000f3fe6080604052600436106101a05760003560e01c8063b1f4e514116100ec578063d78235881161008a578063de65256e11610064578063de65256e146105a0578063dfc9bbf6146105b5578063f14d87dd146105ca578063f2b190ab146105f4576101f5565b8063d782358814610537578063d8e136e214610561578063da5a22311461058b576101f5565b8063cf5fbb38116100c6578063cf5fbb381461048c578063d06d648c146104bf578063d2785837146104e9578063d2f0013e14610522576101f5565b8063b1f4e51414610436578063bacea65b1461047c578063c4035e3514610484576101f5565b80634ee97a1a11610159578063917155ec11610133578063917155ec146103a6578063927cc064146103bb5780639f3abf28146103ee578063a331f78d14610421576101f5565b80634ee97a1a146103395780636a1c5bd01461034e5780638f005ba214610363576101f5565b80630c7ef9321461024a5780630fc147741461027057806319ab453c146102a05780631fd09689146102d35780632cc0c124146102fa57806343752e8e1461030f576101f5565b366101f557600034116101f3576040805162461bcd60e51b815260206004820152601660248201527572656365697665206d757374206861732076616c756560501b604482015290519081900360640190fd5b005b600034116101f3576040805162461bcd60e51b815260206004820152601760248201527f66616c6c6261636b206d757374206861732076616c7565000000000000000000604482015290519081900360640190fd5b6101f36004803603602081101561026057600080fd5b50356001600160a01b031661064b565b34801561027c57600080fd5b506101f36004803603604081101561029357600080fd5b508035906020013561090e565b3480156102ac57600080fd5b506101f3600480360360208110156102c357600080fd5b50356001600160a01b0316610a2e565b3480156102df57600080fd5b506102e8610ad7565b60408051918252519081900360200190f35b34801561030657600080fd5b506101f3610add565b34801561031b57600080fd5b506101f36004803603602081101561033257600080fd5b5035610c87565b34801561034557600080fd5b506102e8610db8565b34801561035a57600080fd5b506102e8610dbe565b34801561036f57600080fd5b5061038d6004803603602081101561038657600080fd5b5035610dc4565b6040805192835260208301919091528051918290030190f35b3480156103b257600080fd5b506102e8610df2565b3480156103c757600080fd5b506101f3600480360360208110156103de57600080fd5b50356001600160a01b0316610df8565b3480156103fa57600080fd5b506101f36004803603602081101561041157600080fd5b50356001600160a01b0316610f53565b34801561042d57600080fd5b5061038d6110bd565b34801561044257600080fd5b506104606004803603602081101561045957600080fd5b5035611190565b604080516001600160a01b039092168252519081900360200190f35b6101f36111ba565b6101f36115b3565b34801561049857600080fd5b5061038d600480360360208110156104af57600080fd5b50356001600160a01b0316611ab9565b3480156104cb57600080fd5b506102e8600480360360208110156104e257600080fd5b5035611c7c565b3480156104f557600080fd5b5061038d6004803603604081101561050c57600080fd5b506001600160a01b038135169060200135611c9d565b34801561052e57600080fd5b50610460611cd9565b34801561054357600080fd5b506101f36004803603602081101561055a57600080fd5b5035611ce8565b34801561056d57600080fd5b506104606004803603602081101561058457600080fd5b5035611e1d565b34801561059757600080fd5b50610460611e2d565b3480156105ac57600080fd5b506102e8611e3c565b3480156105c157600080fd5b506101f3611e42565b3480156105d657600080fd5b506102e8600480360360208110156105ed57600080fd5b50356123b2565b34801561060057600080fd5b5061062d6004803603604081101561061757600080fd5b506001600160a01b0381351690602001356123c2565b60408051938452602084019290925282820152519081900360600190f35b6001600160a01b03811661069a576040805162461bcd60e51b815260206004820152601160248201527021b630b4b6902fb0b232391032b93937b960791b604482015290519081900360640190fd5b600080805b336000908152600c602052604090205481101561079957336000908152600c602052604090208054618ca0916106fa91849081106106d957fe5b9060005260206000209060020201600101544361240490919063ffffffff16565b1061073e57336000908152600c60205260409020805461073791908390811061071f57fe5b6000918252602090912060029091020154839061241e565b9150610791565b336000908152600c6020526040902080548491908390811061075c57fe5b600091825260208083208454600181810187559585529190932060029283029093018054919092029092019182558201549101555b60010161069f565b50600081116107a957505061090b565b815461085257336000908152600c602052604081206107c79161312e565b60005b600b5481101561084c57336001600160a01b0316600b82815481106107eb57fe5b6000918252602090912001546001600160a01b03161415610844576000600b828154811061081557fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6001016107ca565b50610871565b336000908152600c60205260409020825461086f9190849061314f565b505b6040516001600160a01b0384169082156108fc029083906000818181858888f193505050501580156108a7573d6000803e3d6000fd5b50604080516001600160a01b03851681526020810183905281517f664e3a5109f43051dae9a2b55c03407adaa61f302efb53c077da6b44043fa02f929181900390910190a16002546001600160a01b03163314156109085761090883612437565b50505b50565b6006546001600160a01b0316331461096d576040805162461bcd60e51b815260206004820152601d60248201527f4368616e6765506572696f64206f6e6c792073657420627920726f6f74000000604482015290519081900360640190fd5b816109a95760405162461bcd60e51b81526004018080602001828103825260248152602001806132916024913960400191505060405180910390fd5b806109e55760405162461bcd60e51b815260040180806020018281038252602681526020018061339d6026913960400191505060405180910390fd5b60078290556008819055604080518381526020810183905281517f33dae5695f66eeee7dd304fb4fef60cb0186a9f47b5757dd9fda831d56bf4f5a929181900390910190a15050565b6006546001600160a01b031615610a85576040805162461bcd60e51b8152602060048201526016602482015275696e69742063616e206f6e6c792072756e206f6e636560501b604482015290519081900360640190fd5b600680546001600160a01b039092166001600160a01b03199283161790556276a700600755620151806008556003600e55678ac7230489e80000600f55426005556002805490911663deadbeef179055565b600f5481565b6006546001600160a01b03163314610b3c576040805162461bcd60e51b815260206004820152601b60248201527f47657450726f666974206f6e6c792063616c6c20627920726f6f740000000000604482015290519081900360640190fd5b600060055411610b7d5760405162461bcd60e51b81526004018080602001828103825260278152602001806133506027913960400191505060405180910390fd5b610b85612612565b6000805b600954811015610c045760006001600160a01b031660098281548110610bab57fe5b6000918252602090912001546001600160a01b031614610bfc57610bf9610bf260098381548110610bd857fe5b6000918252602090912001546001600160a01b031661287a565b839061241e565b91505b600101610b89565b50610c0d6131af565b50604080518082019091529081524360208201908152600d805460018101825560009190915291517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb5600290930292830155517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb690910155565b600060055411610cde576040805162461bcd60e51b815260206004820152601d60248201527f536574506172616d73206572726f72203a206e6f742073746172746564000000604482015290519081900360640190fd5b6002546001600160a01b03163314610d3d576040805162461bcd60e51b815260206004820152601b60248201527f536574506172616d73206f6e6c79207365742062792061646d696e0000000000604482015290519081900360640190fd5b601e811115610d7d5760405162461bcd60e51b81526004018080602001828103825260278152602001806132496027913960400191505060405180910390fd5b600e8190556040805182815290517fdfa0c5c2ff003a9528ac30ffd70d13630d360b26b9cfcb6455f4cb630bfa149e9181900360200190a150565b60075481565b60085481565b600d8181548110610dd457600080fd5b60009182526020909120600290910201805460019091015490915082565b60055481565b6002546001600160a01b03163314610e57576040805162461bcd60e51b815260206004820152601d60248201527f4368616e676541646d696e206f6e6c79207365742062792061646d696e000000604482015290519081900360640190fd5b6001600160a01b038116610eb2576040805162461bcd60e51b815260206004820152601760248201527f4368616e676541646d696e205f61646472206572726f72000000000000000000604482015290519081900360640190fd5b6002546001600160a01b0382811691161415610eff5760405162461bcd60e51b81526004018080602001828103825260218152602001806134436021913960400191505060405180910390fd5b600280546001600160a01b0383166001600160a01b0319909116811790915560408051918252517f3a00189bcf95fc36fa1adad0441ee0c1abff5a27eb0f705d2c46c23dce3ddada9181900360200190a150565b6006546001600160a01b03163314610fb2576040805162461bcd60e51b815260206004820152601c60248201527f4368616e6765526f6f74206f6e6c79207365742062792061646d696e00000000604482015290519081900360640190fd5b6001600160a01b038116611006576040805162461bcd60e51b815260206004820152601660248201527521b430b733b2a937b7ba102fb0b232391032b93937b960511b604482015290519081900360640190fd5b6006546001600160a01b0382811691161415611069576040805162461bcd60e51b815260206004820181905260248201527f4368616e6765526f6f742063616e206e6f74207365742073616d652061646472604482015290519081900360640190fd5b600680546001600160a01b0383166001600160a01b0319909116811790915560408051918252517f485e105725a3db6421b009bc09fd232847ea51c19d56601a77ae150a4f577fcb9181900360200190a150565b6000806000805b336000908152600c602052604090205481101561112e57336000908152600c602052604090208054618ca0916110fe91849081106106d957fe5b1061112657336000908152600c60205260409020805461112391908390811061071f57fe5b91505b6001016110c4565b506002546000906001600160a01b03163314156111875760005b600d5481101561118557618ca0611165600d83815481106106d957fe5b1061117d5761117a600d828154811061071f57fe5b91505b600101611148565b505b90925090509091565b600b81815481106111a057600080fd5b6000918252602090912001546001600160a01b0316905081565b600060055411611211576040805162461bcd60e51b815260206004820152601c60248201527f4465706f73697465206572726f72203a206e6f74207374617274656400000000604482015290519081900360640190fd5b600f54341015611268576040805162461bcd60e51b815260206004820152601860248201527f4465706f73697465206d6f72652052504720706c656173650000000000000000604482015290519081900360640190fd5b61127a34670de0b6b3a7640000612b00565b156112cc576040805162461bcd60e51b815260206004820152601c60248201527f4465706f7369746520726f756e64206e756d62657220706c6561736500000000604482015290519081900360640190fd5b6002546001600160a01b03163314156113975760035461132e576815af1d78b58c40000034101561132e5760405162461bcd60e51b81526004018080602001828103825260248152602001806132e06024913960400191505060405180910390fd5b600380546001818101909255347fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b90910155600480549182018155600052437f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b90910155611527565b6000600019815b60095481101561142f5760006001600160a01b0316600982815481106113c057fe5b6000918252602090912001546001600160a01b03161480156113e3575060001982145b156113ec578091505b336001600160a01b03166009828154811061140357fe5b6000918252602090912001546001600160a01b03161415611427576001925061142f565b60010161139e565b50816114c257600019811461147f57336009828154811061144c57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055506114c2565b600980546001810182556000919091527f6e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7af0180546001600160a01b031916331790555b6114ca6131c9565b505060408051606081018252348152436020808301918252600e54838501908152336000908152600a8352948520805460018181018355918752929095209351600390920290930190815590519281019290925551600290910155505b3034ee1515600114611577576040805162461bcd60e51b81526020600482015260146024820152732232b837b9b4ba329039ba30b5b29032b93937b960611b604482015290519081900360640190fd5b6040805133815234602082015281517fbde64498c29fbcf96b49024cc85edfa6e6b2eaf65f85aa68f0e5c1f9a00fa904929181900390910190a1565b60008060006115c133612b1d565b90506115cc33612bd7565b60025491945092506001600160a01b0316331415611806576005541580611615575060085461161260075461160c6005544261240490919063ffffffff16565b90612b00565b11155b6116505760405162461bcd60e51b81526004018080602001828103825260268152602001806133776026913960400191505060405180910390fd5b3081ef15156001146116a9576040805162461bcd60e51b815260206004820152601c60248201527f61646d696e20576974686472617720756e7374616b65206572726f7200000000604482015290519081900360640190fd5b6000600019815b600b548110156117415760006001600160a01b0316600b82815481106116d257fe5b6000918252602090912001546001600160a01b03161480156116f5575060001982145b156116fe578091505b336001600160a01b0316600b828154811061171557fe5b6000918252602090912001546001600160a01b031614156117395760019250611741565b6001016116b0565b50816117c25760001981146117915733600b828154811061175e57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055506117c2565b600b80546001810182556000919091526000805160206133308339815191520180546001600160a01b031916331790555b600354600019015b600381815481106117d757fe5b9060005260206000200160009055600481815481106117f257fe5b6000918252602082200155600019016117ca565b6000811161181657505050611ab7565b3081ef1515600114611868576040805162461bcd60e51b81526020600482015260166024820152752bb4ba34323930bb903ab739ba30b5b29032b93937b960511b604482015290519081900360640190fd5b6000600019815b600b548110156119005760006001600160a01b0316600b828154811061189157fe5b6000918252602090912001546001600160a01b03161480156118b4575060001982145b156118bd578091505b336001600160a01b0316600b82815481106118d457fe5b6000918252602090912001546001600160a01b031614156118f85760019250611900565b60010161186f565b50816119815760001981146119505733600b828154811061191d57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550611981565b600b80546001810182556000919091526000805160206133308339815191520180546001600160a01b031916331790555b6119896131af565b604080518082019091528061199e868961241e565b815243602091820152336000908152600c8252604081208054600181810183559183529183902084516002909302019182559183015191015590508415611a60576119e76131af565b50604080518082019091528581524360208201908152600d805460018101825560009190915291517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb5600290930292830155517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb6909101555b611a6933612fea565b50505060408051338152602081018390528082018590526060810184905290517f9c949dc88f7bbc30f196e0c9a134473342e6e79fd3220c1db685a4c7d6beebc19181900360800190a15050505b565b6000806001600160a01b038316611b0f576040805162461bcd60e51b815260206004820152601560248201527423b2ba2932bbb0b932102fb0b232391032b93937b960591b604482015290519081900360640190fd5b600080611b1b85612bd7565b90925090506000805b6001600160a01b0387166000908152600c6020526040902054811015611b77576001600160a01b0387166000908152600c602052604090208054611b6d91908390811061071f57fe5b9150600101611b24565b506002546001600160a01b0387811691161415611c63576000805b600d54811015611bb657611bac600d828154811061071f57fe5b9150600101611b92565b506000805b600954811015611c3d5760006001600160a01b031660098281548110611bdd57fe5b6000918252602090912001546001600160a01b031614611c35576000611c2360098381548110611c0957fe5b6000918252602090912001546001600160a01b0316612bd7565b9150611c319050838261241e565b9250505b600101611bbb565b50611c48858461241e565b945084611c55838361241e565b965096505050505050611c77565b611c6d838261241e565b6000945094505050505b915091565b60038181548110611c8c57600080fd5b600091825260209091200154905081565b600c6020528160005260406000208181548110611cb957600080fd5b600091825260209091206002909102018054600190910154909250905082565b6006546001600160a01b031681565b600060055411611d295760405162461bcd60e51b81526004018080602001828103825260218152602001806132706021913960400191505060405180910390fd5b6002546001600160a01b03163314611d88576040805162461bcd60e51b815260206004820152601f60248201527f536574506172616d4c696d6974206f6e6c79207365742062792061646d696e00604482015290519081900360640190fd5b600081118015611da75750611da581670de0b6b3a7640000612b00565b155b611de25760405162461bcd60e51b815260040180806020018281038252602d8152602001806133c3602d913960400191505060405180910390fd5b600f8190556040805182815290517fb5a976a037fa8c99049961141671394201c185ac0856907a41c370c81cb844909181900360200190a150565b600981815481106111a057600080fd5b6002546001600160a01b031681565b600e5481565b6006546001600160a01b03163314611ea1576040805162461bcd60e51b815260206004820152601f60248201527f556e64656c6567617465416c6c206f6e6c792063616c6c20627920726f6f7400604482015290519081900360640190fd5b60025460009081908190611ebd906001600160a01b0316612b1d565b600254909150611ed5906001600160a01b0316612bd7565b90935091503081ef1515600114611f1d5760405162461bcd60e51b815260040180806020018281038252602a815260200180613419602a913960400191505060405180910390fd5b6000600019815b600b54811015611fbb5760006001600160a01b0316600b8281548110611f4657fe5b6000918252602090912001546001600160a01b0316148015611f69575060001982145b15611f72578091505b600254600b80546001600160a01b039092169183908110611f8f57fe5b6000918252602090912001546001600160a01b03161415611fb35760019250611fbb565b600101611f24565b508161205b57600019811461201a57600254600b80546001600160a01b039092169183908110611fe757fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555061205b565b600254600b80546001810182556000919091526000805160206133308339815191520180546001600160a01b0319166001600160a01b039092169190911790555b600354600019015b6003818154811061207057fe5b90600052602060002001600090556004818154811061208b57fe5b600091825260208220015560001901612063565b6009548110156123ac576000600982815481106120b857fe5b6000918252602090912001546001600160a01b03169050806120da57506123a4565b6120e381612b1d565b92506120ee81612bd7565b9095509350846120fe57506123a4565b3083ef15156001146121415760405162461bcd60e51b81526004018080602001828103825260298152602001806133f06029913960400191505060405180910390fd5b6000600019815b600b548110156121d95760006001600160a01b0316600b828154811061216a57fe5b6000918252602090912001546001600160a01b031614801561218d575060001982145b15612196578091505b836001600160a01b0316600b82815481106121ad57fe5b6000918252602090912001546001600160a01b031614156121d157600192506121d9565b600101612148565b50816122635760001981146122295782600b82815481106121f657fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550612263565b600b80546001810182556000919091526000805160206133308339815191520180546001600160a01b0319166001600160a01b0385161790555b61226b6131af565b6040805180820190915280612280888b61241e565b8152436020918201526001600160a01b0386166000908152600c8252604081208054600181810183559183529183902084516002909302019182559183015191015590506122cc6131af565b50604080518082019091528781524360208201908152600d805460018101825560009190915282517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb560029092029182015590517fd7b6990105719101dabeb77144f2a3385c8033acd3af97e9423a695e81ad1eb69091015561234e85612fea565b604080516001600160a01b0387168152602081018990528082018b9052606081018a905290517f9c949dc88f7bbc30f196e0c9a134473342e6e79fd3220c1db685a4c7d6beebc19181900360800190a150505050505b60010161209f565b50505050565b60048181548110611c8c57600080fd5b600a60205281600052604060002081815481106123de57600080fd5b600091825260209091206003909102018054600182015460029092015490935090915083565b60008282111561241357600080fd5b508082035b92915050565b60008282018381101561243057600080fd5b9392505050565b6002546001600160a01b03163314612496576040805162461bcd60e51b815260206004820152601b60248201527f436c61696d466565206f6e6c792063616c6c2062792061646d696e0000000000604482015290519081900360640190fd5b6001600160a01b0381166124e8576040805162461bcd60e51b815260206004820152601460248201527321b630b4b6a332b2902fb0b232391032b93937b960611b604482015290519081900360640190fd5b600080805b600d5481101561257157618ca061250a600d83815481106106d957fe5b106125265761251f600d828154811061071f57fe5b9150612569565b82600d828154811061253457fe5b600091825260208083208454600181810187559585529190932060029283029093018054919092029092019182558201549101555b6001016124ed565b506000811161258157505061090b565b815461259190600d90849061314f565b506040516001600160a01b0384169082156108fc029083906000818181858888f193505050501580156125c8573d6000803e3d6000fd5b50604080516001600160a01b03851681526020810183905281517fde99e8d5ae50168bd0e8da7b27963feeaeb46af917be4f37a74148b6d4d00101929181900390910190a1505050565b6000600554116126535760405162461bcd60e51b815260040180806020018281038252602c815260200180613304602c913960400191505060405180910390fd5b600254600090819061266d906001600160a01b0316612bd7565b90925090506000600019815b600b548110156127105760006001600160a01b0316600b828154811061269b57fe5b6000918252602090912001546001600160a01b03161480156126be575060001982145b156126c7578091505b600254600b80546001600160a01b0390921691839081106126e457fe5b6000918252602090912001546001600160a01b031614156127085760019250612710565b600101612679565b50816127b057600019811461276f57600254600b80546001600160a01b03909216918390811061273c57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055506127b0565b600254600b80546001810182556000919091526000805160206133308339815191520180546001600160a01b0319166001600160a01b039092169190911790555b6127b86131af565b50604080518082018252858152436020808301918252600280546001600160a01b03166000908152600c83529485208054600181810183559187529286208551939092029091019182559151910155600354909190600019015b61283c6003828154811061282257fe5b90600052602060002001548361241e90919063ffffffff16565b91506003818154811061284b57fe5b90600052602060002001600090556004818154811061286657fe5b600091825260208220015560001901612812565b600080600554116128bc5760405162461bcd60e51b815260040180806020018281038252602b8152602001806132b5602b913960400191505060405180910390fd5b6000806128c884612bd7565b90925090506000600019815b600b548110156129655760006001600160a01b0316600b82815481106128f657fe5b6000918252602090912001546001600160a01b0316148015612919575060001982145b15612922578091505b866001600160a01b0316600b828154811061293957fe5b6000918252602090912001546001600160a01b0316141561295d5760019250612965565b6001016128d4565b50816129ef5760001981146129b55785600b828154811061298257fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055506129ef565b600b80546001810182556000919091526000805160206133308339815191520180546001600160a01b0319166001600160a01b0388161790555b6129f76131af565b506040805180820182528581524360208083019182526001600160a01b038a166000908152600c825293842080546001818101835591865291852084516002909302019182559151910155905b6001600160a01b0388166000908152600a6020526040902054811015612aa9576001600160a01b0388166000908152600a60205260409020805443919083908110612a8b57fe5b60009182526020909120600160039092020181019190915501612a44565b50604080516001600160a01b03891681526020810187905280820186905290517fc3dcd5591a9a5c937be27ea67a07571e7251392216a8e16f7fd1f2bf0c5a559d9181900360600190a1509193505050505b919050565b600081612b0c57600080fd5b818381612b1557fe5b069392505050565b6002546000906001600160a01b0383811691161415612b635760005b600354811015612b5d57612b536003828154811061282257fe5b9150600101612b39565b50612afb565b60005b6001600160a01b0383166000908152600a6020526040902054811015612bd1576001600160a01b0383166000908152600a602052604090208054612bc7919083908110612baf57fe5b6000918252602090912060039091020154839061241e565b9150600101612b66565b50919050565b600080600080600043905060008060008060038054905060001415612bfa575060015b60005b600354811015612c6657612c5c612c5560038381548110612c1a57fe5b9060005260206000200154612c4f60048581548110612c3557fe5b90600052602060002001548a61240490919063ffffffff16565b906130e5565b859061241e565b9350600101612bfd565b5082935060005b600954811015612e8a5760005b600a600060098481548110612c8b57fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902054811015612e81576000612d79612d21600a600060098781548110612cd057fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805485908110612d0057fe5b9060005260206000209060030201600101548a61240490919063ffffffff16565b600a600060098781548110612d3257fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805485908110612d6257fe5b6000918252602090912060039091020154906130e5565b9050612d85878261241e565b96508c6001600160a01b031660098481548110612d9e57fe5b6000918252602090912001546001600160a01b03161415612e785760018415151415612dd557612dce858261241e565b9450612e78565b6000612e526064612e4c612e45600a600060098a81548110612df357fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805488908110612e2357fe5b906000526020600020906003020160020154606461240490919063ffffffff16565b85906130e5565b9061310c565b9050612e5e868261241e565b9550612e74612e6d8383612404565b8b9061241e565b9950505b50600101612c7a565b50600101612c6d565b506000805b600b54811015612f485760005b600c6000600b8481548110612ead57fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902054811015612f3f57612f35600c6000600b8581548110612eed57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805483908110612f1d57fe5b6000918252602090912060029091020154849061241e565b9250600101612e9c565b50600101612e8f565b506000805b600d54811015612f7157612f67600d828154811061071f57fe5b9150600101612f4d565b506000612f8882612f824786612404565b90612404565b6002549091506001600160a01b038e811691161415612fb657612faf87612e4c83896130e5565b9950612fd7565b612fc487612e4c83886130e5565b9950612fd487612e4c838c6130e5565b98505b5097995095975050505050505050915091565b6001600160a01b03811661303a576040805162461bcd60e51b81526020600482015260126024820152713232b63ab9b2b9103830b9309032b93937b960711b604482015290519081900360640190fd5b60005b6009548110156130c357336001600160a01b03166009828154811061305e57fe5b6000918252602090912001546001600160a01b031614156130bb5760006009828154811061308857fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055506130c3565b60010161303d565b506001600160a01b0381166000908152600a6020526040812061090b916131ea565b6000826130f457506000612418565b8282028284828161310157fe5b041461243057600080fd5b600080821161311a57600080fd5b600082848161312557fe5b04949350505050565b508054600082556002029060005260206000209081019061090b919061320b565b82805482825590600052602060002090600202810192821561319f5760005260206000209160020282015b8281111561319f5782548255600180840154908301556002928301929091019061317a565b506131ab92915061320b565b5090565b604051806040016040528060008152602001600081525090565b60405180606001604052806000815260200160008152602001600081525090565b508054600082556003029060005260206000209081019061090b9190613226565b5b808211156131ab576000808255600182015560020161320c565b5b808211156131ab57600080825560018201819055600282015560030161322756fe536574506172616d73205f66656570657263656e74206f6e6c792063616e2073657420302d3330536574506172616d4c696d6974206572726f72203a206e6f7420737461727465644368616e6765506572696f64205f61646d696e6c696d6974706572696f64206572726f725573657247657450726f6669742063616e206e6f742063616c6c207768656e206e6f7420737461727465644465706f736974652061646d696e207265616464206d757374203e3d203430302052504741646d696e47657450726f6669742063616e206e6f742063616c6c207768656e206e6f7420737461727465640175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db947657450726f6669742063616e206e6f742063616c6c207768656e206e6f74207374617274656457697468647261772c2061646d696e206e6f7420696e20776974686472617720706572696f644368616e6765506572696f64205f61646d696e72656c65617365706572696f64206572726f72536574506172616d4c696d6974205f7374616b656c696d697420726f756e64206e756d62657220706c65617365556e64656c6567617465416c6c207573657220576974686472617720756e7374616b65206572726f72556e64656c6567617465416c6c2061646d696e20576974686472617720756e7374616b65206572726f724368616e676541646d696e2063616e206e6f74207365742073616d652061646472a2646970667358221220bf24cf59452f9fba69bc06157e483d2aed3c484b3d74f50fe794f53803700e1764736f6c6375302e372e352b636f6d6d69742e65623737656430380045")
	maincontract := common.FromHex("608060405234801561001057600080fd5b506107e4806100206000396000f3fe60806040526004361061001e5760003560e01c80638e900fd214610023575b600080fd5b61004f6004803603604081101561003957600080fd5b50803590602001356001600160a01b0316610051565b005b606060405180602001610063906103a6565b6020820181038252601f19601f820116604052509050600081518481602085016000f5915050803b61009457600080fd5b604080516001600160a01b0380861660248084019190915283518084039091018152604490920183526020820180516001600160e01b031662900f0160e41b178152925182519293600093606093871692869290918291908083835b6020831061010f5780518252601f1990920191602091820191016100f0565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d8060008114610171576040519150601f19603f3d011682016040523d82523d6000602084013e610176565b606091505b50915091508161018557600080fd5b604080513360248083019190915282518083039091018152604490910182526020810180516001600160e01b031663198b93b960e21b178152915181519195506001600160a01b0387169286928291908083835b602083106101f85780518252601f1990920191602091820191016101d9565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d806000811461025a576040519150601f19603f3d011682016040523d82523d6000602084013e61025f565b606091505b5090925090508161026f57600080fd5b604080513360248083019190915282518083039091018152604490910182526020810180516001600160e01b031663066ad14f60e21b178152915181519195506001600160a01b0387169286928291908083835b602083106102e25780518252601f1990920191602091820191016102c3565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d8060008114610344576040519150601f19603f3d011682016040523d82523d6000602084013e610349565b606091505b5090925090508161035957600080fd5b604080516001600160a01b03861681526020810189905281517fb03c53b28e78a88e31607a27e1fa48234dce28d5d9d9ec7b295aeb02e674a1e1929181900390910190a150505050505050565b6103e9806103b48339019056fe608060405234801561001057600080fd5b50600180546001600160a01b031916331790556103b7806100326000396000f3fe6080604052600436106100435760003560e01c80630900f0101461008e578063662e4ee4146100c35780638da5cb5b146100f65780638f32d59b146101275761004a565b3661004a57005b600080546001600160a01b0316813563530ca43760e11b141561006f57808252602082f35b3682833781823684845af490503d82833e80610089573d82fd5b503d81f35b34801561009a57600080fd5b506100c1600480360360208110156100b157600080fd5b50356001600160a01b0316610150565b005b3480156100cf57600080fd5b506100c1600480360360208110156100e657600080fd5b50356001600160a01b031661025e565b34801561010257600080fd5b5061010b610324565b604080516001600160a01b039092168252519081900360200190f35b34801561013357600080fd5b5061013c610333565b604080519115158252519081900360200190f35b610158610333565b61016157600080fd5b6001600160a01b0381166101b2576040805162461bcd60e51b8152602060048201526013602482015272757067726164652077726f6e6720706172616d60681b604482015290519081900360640190fd5b6101c4816001600160a01b0316610344565b15156001146102045760405162461bcd60e51b815260040180806020018281038252602581526020018061034b6025913960400191505060405180910390fd5b600080546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517fdf4e60358b29f369ae3e62e25ba3b229bab738ad23e057ef063141c7ef559814916020908290030190a150565b610266610333565b61026f57600080fd5b6001600160a01b0381166102ca576040805162461bcd60e51b815260206004820152601760248201527f6368616e67656f776e65722077726f6e6720706172616d000000000000000000604482015290519081900360640190fd5b600180546001600160a01b0319166001600160a01b03838116919091179182905560408051929091168252517f6972f954346c124a4639edfe943e82b1c2d812116e4a30822027087767f745a2916020908290030190a150565b6001546001600160a01b031690565b6001546001600160a01b0316331490565b3b15159056fe757067726164652061646472206d75737420626520636f6e74726163742061646472657373a26469706673582212203fa4e42599f27263c18bb18e149a1008253fd9f05984c916dfece599525e9c3d64736f6c6375302e372e352b636f6d6d69742e65623737656430380045a2646970667358221220d288264c0944341532e1b4c3b22b92fd7dc84d19d7817b3a04a0d251d8f5490664736f6c6375302e372e352b636f6d6d69742e65623737656430380045")

	_, minerstakeAddress, createLeftGas, createErr := mockCreate(minerstake, config)
	fmt.Printf("New create minerstake address:%s\n", minerstakeAddress.GetHexString())
	fmt.Printf("New create minerstake costGas: %v,createErr:%v\n", config.GasLimit-createLeftGas, createErr)

	_, maincontractAddress, createLeftGas, createErr := mockCreate(maincontract, config)
	fmt.Printf("New create maincontract address:%s\n", maincontractAddress.GetHexString())
	fmt.Printf("New create maincontract costGas: %v,createErr: %v\n", config.GasLimit-createLeftGas, createErr)

	input := generateCall(1, minerstakeAddress)
	callResult, callLeftGas, logs, callErr := mockCallWithLogs(maincontractAddress, input, config)
	fmt.Printf("callResult: %v,costGas: %d,callErr: %v\n", callResult, config.GasLimit-callLeftGas, callErr)

	if 3 != len(logs) {
		t.Fatal("wrong length")
	}
	log := logs[2]
	realAddress := common.BytesToAddress(log.Data[:32])
	fmt.Println("real address: " + realAddress.String())
}

func generateCall(salt int, address common.Address) []byte {
	saltString := strconv.Itoa(salt)
	length := len(saltString)
	if length > 64 {
		return nil
	}
	pad := ""
	for i := 0; i < (64 - length); i++ {
		pad = "0" + pad
	}

	addressString := address.String()
	inputString := fmt.Sprintf("0x8e900fd2%s%s000000000000000000000000%s", pad, saltString, addressString[2:])
	return common.FromHex(inputString)
}
